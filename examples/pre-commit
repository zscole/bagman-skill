#!/bin/bash
# Bagman Pre-commit Hook - Secret Detection
# Install: cp examples/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "üîê Bagman: Scanning for secrets..."

# Patterns to detect
declare -a PATTERNS=(
    '0x[a-fA-F0-9]{64}'                      # ETH private keys
    'PRIVATE_KEY=.{20,}'                     # Generic private key
    'sk-[a-zA-Z0-9]{48,}'                    # OpenAI
    'sk-ant-api[0-9]{2}-[a-zA-Z0-9\-_]{80,}' # Anthropic
    'gsk_[a-zA-Z0-9]{48,}'                   # Groq
    'AKIA[0-9A-Z]{16}'                       # AWS Access Key
    'ghp_[a-zA-Z0-9]{36}'                    # GitHub PAT
    'glpat-[a-zA-Z0-9\-]{20}'               # GitLab PAT
)

FILES=$(git diff --cached --name-only --diff-filter=ACM)
FOUND_SECRETS=0

for file in $FILES; do
    # Skip binary and lock files
    if [[ "$file" =~ \.(png|jpg|gif|ico|woff|ttf|lock|min\.js)$ ]]; then
        continue
    fi
    
    # Skip node_modules, vendor
    if [[ "$file" =~ ^(node_modules|vendor|\.git)/ ]]; then
        continue
    fi
    
    for pattern in "${PATTERNS[@]}"; do
        if git diff --cached "$file" | grep -qE "$pattern"; then
            echo -e "${RED}‚ùå Potential secret in: $file${NC}"
            echo "   Pattern: $pattern"
            git diff --cached "$file" | grep -E "$pattern" | head -2
            FOUND_SECRETS=1
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ö†Ô∏è  Secrets detected! Commit blocked.${NC}"
    echo ""
    echo "Options:"
    echo "  1. Remove the secrets"
    echo "  2. Use 1Password/secret manager instead"
    echo "  3. Bypass (risky): git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}‚úÖ No secrets detected${NC}"
